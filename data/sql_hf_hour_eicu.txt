with target_cohort_ as(
	SELECT distinct patientunitstayid 
	FROM "diagnosis" where lower(diagnosisstring) like '%heart failure%' or lower(diagnosisstring) like '%heartfailure%'
	order by patientunitstayid
)

, target_cohort as(
	select patienthealthsystemstayid, patientunitstayid
	, (case
			when unitdischargestatus = 'Alive'
				then 0
			when unitdischargestatus = 'Expired'
				then 1
			else NULL end) as final_expire_flag
	from target_cohort_
	right join patient using (patientunitstayid)
	where (unitdischargestatus ='Alive' or unitdischargestatus = 'Expired')
		and ((unitvisitnumber = 1 or unitvisitnumber = '1') and unitstaytype = 'admit')
	order by patienthealthsystemstayid, patientunitstayid asc
)

, bp_systolic_0 as(
	select patientunitstayid, observationoffset/60 as hourint, observationoffset
	, avg(case
			when systemicsystolic is not NULL
				then systemicsystolic
			else (case
				when pasystolic is not NULL
					then pasystolic
				else noninvasivesystolic end)end
				) as bp_systolic
	from target_cohort
	left join vitalaperiodic using (patientunitstayid)
	left join vitalperiodic using (patientunitstayid, observationoffset)
	where observationoffset <= 48*60 and observationoffset >=0
	-- and bp_systolic is not NULL
	group by patientunitstayid, observationoffset
	order by patientunitstayid, observationoffset
)

, bp_systolic_time as(
	select patientunitstayid, hourint, max(observationoffset) as observationoffset
	from bp_systolic_0
	where bp_systolic is not NULL
	group by patientunitstayid, hourint
)

, bp_systolic as (
	select patientunitstayid, hourint, bp_systolic
	from bp_systolic_time
	left join bp_systolic_0 using (patientunitstayid, hourint, observationoffset)
	order by patientunitstayid, hourint
)

, bp_mean_0 as(
	select patientunitstayid, observationoffset/60 as hourint, observationoffset
	, avg(case
			when systemicmean is not NULL
				then systemicmean
			else (case
				when pamean is not NULL
					then pamean
				else noninvasivemean end)end
				) as bp_mean
	from target_cohort
	left join vitalaperiodic using (patientunitstayid)
	left join vitalperiodic using (patientunitstayid, observationoffset)
	where observationoffset <= 48*60 and observationoffset >=0
	-- and bp_systolic is not NULL
	group by patientunitstayid, observationoffset
	order by patientunitstayid, observationoffset
)

, bp_mean_time as(
	select patientunitstayid, hourint, max(observationoffset) as observationoffset
	from bp_mean_0
	where bp_mean is not NULL
	group by patientunitstayid, hourint
)

, bp_mean as (
	select patientunitstayid, hourint, bp_mean
	from bp_mean_time
	left join bp_mean_0 using (patientunitstayid, hourint, observationoffset)
	order by patientunitstayid, hourint
)

, heartrate_0 as (
	select patientunitstayid, observationoffset/60 as hourint, observationoffset, avg(heartrate) as heartrate
	from target_cohort
	left join vitalperiodic using (patientunitstayid)
	where observationoffset <= 48*60 and observationoffset >=0
	group by (patientunitstayid, observationoffset)
	order by patientunitstayid, observationoffset
)

, heartrate_time as(
	select patientunitstayid, hourint, max(observationoffset) as observationoffset
	from heartrate_0
	where heartrate is not NULL
	group by patientunitstayid, hourint
)

, heartrate as (
	select patientunitstayid, hourint, heartrate
	from heartrate_time
	left join heartrate_0 using (patientunitstayid, hourint, observationoffset)
	order by patientunitstayid, hourint
)

, respiratory_rate_0 as (
	select patientunitstayid, observationoffset/60 as hourint, observationoffset, avg(respiration) as respiratory_rate
	from target_cohort
	left join vitalperiodic using (patientunitstayid)
	where observationoffset <= 48*60 and observationoffset >=0
	group by (patientunitstayid, observationoffset)
	order by patientunitstayid, observationoffset
)

, respiratory_rate_time as(
	select patientunitstayid, hourint, max(observationoffset) as observationoffset
	from respiratory_rate_0
	where respiratory_rate is not NULL
	group by patientunitstayid, hourint
)

, respiratory_rate as (
	select patientunitstayid, hourint, respiratory_rate
	from respiratory_rate_time
	left join respiratory_rate_0 using (patientunitstayid, hourint, observationoffset)
	order by patientunitstayid, hourint
)

, sao2_0 as (
	select patientunitstayid, observationoffset/60 as hourint, observationoffset, avg(sao2) as sao2
	from target_cohort
	left join vitalperiodic using (patientunitstayid)
	where observationoffset <= 48*60 and observationoffset >=0
	group by (patientunitstayid, observationoffset)
	order by patientunitstayid, observationoffset
)

, sao2_time as(
	select patientunitstayid, hourint, max(observationoffset) as observationoffset
	from sao2_0
	where sao2 is not NULL
	group by patientunitstayid, hourint
)

, sao2 as (
	select patientunitstayid, hourint, sao2
	from sao2_time
	left join sao2_0 using (patientunitstayid, hourint, observationoffset)
	order by patientunitstayid, hourint
)

, hemoglobin_0 as (
	select patientunitstayid, labresultoffset/60 as hourint, labresultoffset as observationoffset, avg(labresult) as hemoglobin
	from target_cohort
	left join lab using (patientunitstayid)
	where labresultoffset >=0 and labresultoffset <= 60*48 and labname = 'Hgb'
	group by (patientunitstayid, labresultoffset)
	order by patientunitstayid, labresultoffset
)

, hemoglobin_time as(
	select patientunitstayid, hourint, max(observationoffset) as observationoffset
	from hemoglobin_0
	where hemoglobin is not NULL
	group by patientunitstayid, hourint
)

, hemoglobin as (
	select patientunitstayid, hourint, hemoglobin
	from hemoglobin_time
	left join hemoglobin_0 using (patientunitstayid, hourint, observationoffset)
	order by patientunitstayid, hourint
)

, glucose_0 as (
	select patientunitstayid, chartoffset/60 as hourint, chartoffset as observationoffset, avg(glucose) as glucose
	from target_cohort
	left join pivoted_lab using (patientunitstayid)
	where chartoffset <= 48*60 and chartoffset >=0
	group by (patientunitstayid, chartoffset)
	order by patientunitstayid, chartoffset
)

, glucose_time as(
	select patientunitstayid, hourint, max(observationoffset) as observationoffset
	from glucose_0
	where glucose is not NULL
	group by patientunitstayid, hourint
)

, glucose as (
	select patientunitstayid, hourint, glucose
	from glucose_time
	left join glucose_0 using (patientunitstayid, hourint, observationoffset)
	order by patientunitstayid, hourint
) 

, fio2_0 as (
	select patientunitstayid, chartoffset/60 as hourint, chartoffset as observationoffset, avg(fio2) as fio2
	from target_cohort
	left join pivoted_bg using (patientunitstayid)
	where chartoffset <= 48*60 and chartoffset >=0
	group by (patientunitstayid, chartoffset)
	order by patientunitstayid, chartoffset
)

, fio2_time as(
	select patientunitstayid, hourint, max(observationoffset) as observationoffset
	from fio2_0
	where fio2 is not NULL
	group by patientunitstayid, hourint
)

, fio2 as (
	select patientunitstayid, hourint, fio2
	from fio2_time
	left join fio2_0 using (patientunitstayid, hourint, observationoffset)
	order by patientunitstayid, hourint
) 

, alt_0 as (
	select patientunitstayid, chartoffset/60 as hourint, chartoffset as observationoffset, avg(alt) as alt
	from target_cohort
	left join pivoted_lab using (patientunitstayid)
	where chartoffset <= 48*60 and chartoffset >=0
	group by (patientunitstayid, chartoffset)
	order by patientunitstayid, chartoffset
)

, alt_time as(
	select patientunitstayid, hourint, max(observationoffset) as observationoffset
	from alt_0
	where alt is not NULL
	group by patientunitstayid, hourint
)

, alt as (
	select patientunitstayid, hourint, alt
	from alt_time
	left join alt_0 using (patientunitstayid, hourint, observationoffset)
	order by patientunitstayid, hourint
) 

, ast_0 as (
	select patientunitstayid, chartoffset/60 as hourint, chartoffset as observationoffset, avg(ast) as ast
	from target_cohort
	left join pivoted_lab using (patientunitstayid)
	where chartoffset <= 48*60 and chartoffset >=0
	group by (patientunitstayid, chartoffset)
	order by patientunitstayid, chartoffset
)

, ast_time as(
	select patientunitstayid, hourint, max(observationoffset) as observationoffset
	from ast_0
	where ast is not NULL
	group by patientunitstayid, hourint
)

, ast as (
	select patientunitstayid, hourint, ast
	from ast_time
	left join ast_0 using (patientunitstayid, hourint, observationoffset)
	order by patientunitstayid, hourint
) 

, spo2_0 as (
	select patientunitstayid, chartoffset/60 as hourint, chartoffset as observationoffset, avg(spo2) as spo2
	from target_cohort
	left join pivoted_vital using (patientunitstayid)
	where chartoffset <= 48*60 and chartoffset >=0
	group by (patientunitstayid, chartoffset)
	order by patientunitstayid, chartoffset
)

, spo2_time as(
	select patientunitstayid, hourint, max(observationoffset) as observationoffset
	from spo2_0
	where spo2 is not NULL
	group by patientunitstayid, hourint
)

, spo2 as (
	select patientunitstayid, hourint, spo2
	from spo2_time
	left join spo2_0 using (patientunitstayid, hourint, observationoffset)
	order by patientunitstayid, hourint
) 

, body_temperature_0 as (
	select patientunitstayid, chartoffset/60 as hourint, chartoffset as observationoffset, avg(temperature) as body_temperature
	from target_cohort
	left join pivoted_vital using (patientunitstayid)
	where chartoffset <= 48*60 and chartoffset >=0 and lower(temperaturelocation) = 'oral'
	group by (patientunitstayid, chartoffset)
	order by patientunitstayid, chartoffset
)

, body_temperature_time as(
	select patientunitstayid, hourint, max(observationoffset) as observationoffset
	from body_temperature_0
	where body_temperature is not NULL
	group by patientunitstayid, hourint
)

, body_temperature as (
	select patientunitstayid, hourint, body_temperature
	from body_temperature_time
	left join body_temperature_0 using (patientunitstayid, hourint, observationoffset)
	order by patientunitstayid, hourint
)

, main_0 as(
	select patientunitstayid, hourint, bp_systolic, bp_mean, heartrate, respiratory_rate, spo2, hemoglobin, glucose, body_temperature, fio2, sao2, alt, ast, final_expire_flag
	from bp_systolic
	full outer join bp_mean using (patientunitstayid, hourint)
	full outer join heartrate using (patientunitstayid, hourint)
	full outer join respiratory_rate using (patientunitstayid, hourint)
	full outer join spo2 using (patientunitstayid, hourint)
	full outer join hemoglobin using (patientunitstayid, hourint)
	full outer join glucose using (patientunitstayid, hourint)
	full outer join body_temperature using (patientunitstayid, hourint)
	full outer join fio2 using (patientunitstayid, hourint)
	full outer join alt using (patientunitstayid, hourint)
	full outer join ast using (patientunitstayid, hourint)
	full outer join sao2 using (patientunitstayid, hourint)
	
	left join target_cohort using (patientunitstayid)
)

, nitroglycerin_0 as (
	select patientunitstayid, infusionoffset/60 as hourint, drugrate
	from main_0 m
	full outer join infusiondrug i using (patientunitstayid)
	where lower(drugname) like '%nitroglycerin%'
		and m.hourint = i.infusionoffset/60
		and infusionoffset >= 0 and infusionoffset <= 48*60
	order by patientunitstayid, hourint
)

, nitroglycerin as(
	select patientunitstayid, hourint
		, max(case
				when drugrate is not null and drugrate != '0'
					then 1
				else 0 end)as nitroglycerin
	from nitroglycerin_0
	group by patientunitstayid, hourint
	order by patientunitstayid, hourint
)

, diltiazem_0 as (
	select patientunitstayid, infusionoffset/60 as hourint, drugrate
	from main_0 m
	full outer join infusiondrug i using (patientunitstayid)
	where lower(drugname) like '%diltiazem%'
		and m.hourint = i.infusionoffset/60
		and infusionoffset >= 0 and infusionoffset <= 48*60
	order by patientunitstayid, hourint
)

, diltiazem as(
	select patientunitstayid, hourint
		, max(case
				when drugrate is not null and drugrate != '0'
					then 1
				else 0 end)as diltiazem
	from diltiazem_0
	group by patientunitstayid, hourint
	order by patientunitstayid, hourint
)

, esmolol_0 as (
	select patientunitstayid, infusionoffset/60 as hourint, drugrate
	from main_0 m
	full outer join infusiondrug i using (patientunitstayid)
	where lower(drugname) like '%esmolol%'
		and m.hourint = i.infusionoffset/60
		and infusionoffset >= 0 and infusionoffset <= 48*60
	order by patientunitstayid, hourint
)

, esmolol as(
	select patientunitstayid, hourint
		, max(case
				when drugrate is not null and drugrate != '0'
					then 1
				else 0 end)as esmolol
	from esmolol_0
	group by patientunitstayid, hourint
	order by patientunitstayid, hourint
)

, metoprolol_0 as (
	select patientunitstayid, hourint
	, (case 
			when hourint >= drugstartoffset/60 or hourint+1 <= ceil(drugstopoffset/60.0)
				then 1
			else 0 end) as metoprolol
	from main_0
	left join medication using (patientunitstayid)
	where lower(drugname) like '%metoprolol%'
		and drugstartoffset >= 0 and drugstartoffset <= 48*60
	order by patientunitstayid, hourint
)

, metoprolol as(
	select patientunitstayid, hourint, max(metoprolol) as metoprolol
	from metoprolol_0
	group by patientunitstayid, hourint
	order by patientunitstayid, hourint
) 

, atorvastatin_0 as (
	select patientunitstayid, hourint
	, (case 
			when hourint >= drugstartoffset/60 or hourint+1 <= ceil(drugstopoffset/60.0)
				then 1
			else 0 end) as atorvastatin
	from main_0
	left join medication using (patientunitstayid)
	where lower(drugname) like '%atorvastatin%'
		and drugstartoffset >= 0 and drugstartoffset <= 48*60
	order by patientunitstayid, hourint
)

, atorvastatin as(
	select patientunitstayid, hourint, max(atorvastatin) as atorvastatin
	from atorvastatin_0
	group by patientunitstayid, hourint
	order by patientunitstayid, hourint
) 

, simvastatin_0 as (
	select patientunitstayid, hourint
	, (case 
			when hourint >= drugstartoffset/60 or hourint+1 <= ceil(drugstopoffset/60.0)
				then 1
			else 0 end) as simvastatin
	from main_0
	left join medication using (patientunitstayid)
	where lower(drugname) like '%simvastatin%'
		and drugstartoffset >= 0 and drugstartoffset <= 48*60
	order by patientunitstayid, hourint
)

, simvastatin as(
	select patientunitstayid, hourint, max(simvastatin) as simvastatin
	from simvastatin_0
	group by patientunitstayid, hourint
	order by patientunitstayid, hourint
) 

, aspirin_0 as (
	select patientunitstayid, hourint
	, (case 
			when hourint >= drugstartoffset/60 or hourint+1 <= ceil(drugstopoffset/60.0)
				then 1
			else 0 end) as aspirin
	from main_0
	left join medication using (patientunitstayid)
	where lower(drugname) like '%aspirin%'
		and drugstartoffset >= 0 and drugstartoffset <= 48*60
	order by patientunitstayid, hourint
)

, aspirin as(
	select patientunitstayid, hourint, max(aspirin) as aspirin
	from aspirin_0
	group by patientunitstayid, hourint
	order by patientunitstayid, hourint
) 

, clopidogrel_0 as (
	select patientunitstayid, drugstartoffset, drugstopoffset
	from medication
	where lower(drugname) like '%clopidogrel%'
	order by patientunitstayid, drugstartoffset, drugstopoffset
)

, clopidogrel_1 as (
	select patientunitstayid, hourint
	, (case 
			when hourint >= drugstartoffset/60 or hourint+1 <= ceil(drugstopoffset/60.0)
				then 1
			else 0 end) as clopidogrel
	from main_0
	left join clopidogrel_0 using (patientunitstayid)
	where drugstartoffset >= 0 and drugstartoffset <= 48*60
	order by patientunitstayid, hourint
)

, clopidogrel as(
	select patientunitstayid, hourint, max(clopidogrel) as clopidogrel
	from clopidogrel_1
	group by patientunitstayid, hourint
	order by patientunitstayid, hourint
) 

, main_ as (
	select patientunitstayid, hourint
	, bp_systolic,bp_mean,heartrate,respiratory_rate,spo2,hemoglobin,glucose,body_temperature,fio2,sao2,alt,ast
	, nitroglycerin,diltiazem,esmolol
	, metoprolol,atorvastatin,simvastatin,aspirin,clopidogrel
	, final_expire_flag
	from main_0
	full outer join nitroglycerin using (patientunitstayid,hourint)
	full outer join diltiazem using (patientunitstayid,hourint)
	full outer join esmolol using (patientunitstayid,hourint)
	left join metoprolol using (patientunitstayid,hourint)
	left join atorvastatin using (patientunitstayid,hourint)
	left join simvastatin using (patientunitstayid,hourint)
	left join aspirin using (patientunitstayid,hourint)
	left join clopidogrel using (patientunitstayid,hourint)
	order by patientunitstayid,hourint
)

, main as (
	select patientunitstayid, hourint
	, bp_systolic,bp_mean,heartrate,respiratory_rate,spo2,hemoglobin,glucose,body_temperature,fio2,sao2,alt,ast
	, (case when nitroglycerin is null then 0 else nitroglycerin end)as nitroglycerin,(case when diltiazem is null then 0 else diltiazem end) as diltiazem,(case when esmolol is null then 0 else esmolol end) as esmolol
	, (case when metoprolol is null then 0 else metoprolol end)as metoprolol,(case when atorvastatin is null then 0 else atorvastatin end)as atorvastatin,(case when simvastatin is null then 0 else simvastatin end)as simvastatin,(case when aspirin is null then 0 else aspirin end)as aspirin,(case when clopidogrel is null then 0 else clopidogrel end)as clopidogrel
	, final_expire_flag
	from main_
	order by patientunitstayid,hourint
)

select *
from main
order by patientunitstayid,hourint;