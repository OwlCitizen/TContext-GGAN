with target_cohort as
(
	select distinct subject_id, hadm_id
	from diagnoses_icd 
	where icd_code = '39891  'or icd_code = '40201  'or icd_code = '40211  'or icd_code = '40291  'or icd_code = '40401  'or icd_code = '40403  'or icd_code = '40411  'or icd_code = '40413  'or icd_code = '40491  'or icd_code ='40493  'or icd_code = '42842  'or icd_code = '4280   'or icd_code = '4281   'or icd_code = '42820  'or icd_code = '42821  'or icd_code = '42822  'or icd_code = '42823  'or icd_code = '42830  'or icd_code = '42831  'or icd_code = '42832  'or icd_code = '42833  'or icd_code = '42840  'or icd_code = '42841  'or icd_code = '42843  'or icd_code = '4289   'or icd_code = 'I0981  'or icd_code = 'I110   'or icd_code = 'I119   'or icd_code = 'I130   'or icd_code = 'I132   'or icd_code = 'I5020  'or icd_code = 'I5021  'or icd_code = 'I5022  'or icd_code = 'I5023  'or icd_code = 'I5030  'or icd_code = 'I5031  'or icd_code = 'I5032  'or icd_code = 'I5033  'or icd_code = 'I5040  'or icd_code = 'I5041  'or icd_code = 'I5042  'or icd_code = 'I5043  'or icd_code = 'I50810 'or icd_code = 'I50811 'or icd_code = 'I50812 'or icd_code = 'I50813 'or icd_code = 'I50814 'or icd_code = 'I5082  'or icd_code = 'I5083  'or icd_code = 'I5084  'or icd_code = 'I5089  'or icd_code = 'I509   'or icd_code = 'I97130 'or icd_code = 'I97131 '
	order by subject_id, hadm_id
)

, icustay_ as
(
	select hadm_id, min(intime) as intime
	from icustays
	group by hadm_id
	order by hadm_id,intime
)

, icustay as
(
	select i1.hadm_id, i1.intime as icustart
	, (case 
			when outtime < (i1.intime + interval '48' HOUR)
				then outtime
			else (i1.intime + interval '48' HOUR) end)as icuend
	from icustay_ i1
	left join icustays i2 on i1.hadm_id=i2.hadm_id and i1.intime = i2.intime
	where i1.intime is not null and outtime is not null -- and outtime >= (intime + interval '48' HOUR)
)

, death as
(
	select hadm_id, hospital_expire_flag as final_expire_flag
	from admissions
	order by hadm_id
)

, BP_S as
(
	select hadm_id, charttime as time, avg(valuenum) as Arterial_BP_Systolic
	from chartevents
	right join target_cohort using (hadm_id)
	where itemid in (220179,220050) and valuenum!=0
	group by (hadm_id,time)
	order by hadm_id, time
)

, BP_M as
(
	select hadm_id, charttime as time, avg(valuenum) as Arterial_BP_Mean
	from chartevents
	right join target_cohort using (hadm_id)
	where itemid in (220052,220181,225312) and valuenum!=0
	group by (hadm_id,time)
	order by hadm_id, time
)

, Heart_Rate as
(
	select hadm_id, charttime as time, avg(valuenum) as Heart_Rate
	from chartevents
	right join target_cohort using (hadm_id)
	where itemid in (220045)
	group by (hadm_id,time)
	order by hadm_id, time
)

, Respiratory_Rate as
(
	select hadm_id, charttime as time, avg(valuenum) as Respiratory_Rate
	from chartevents
	right join target_cohort using (hadm_id)
	where itemid in (220210,224690)
	group by (hadm_id,time)
	order by hadm_id, time
)

, SpO2 as
(
	select hadm_id, charttime as time, avg(valuenum) as SpO2
	from chartevents
	right join target_cohort using (hadm_id)
	where itemid in (220277)
	group by (hadm_id,time)
	order by hadm_id, time
)

, hemoglobin as
(
SELECT hadm_id, charttime as time, avg(valuenum) as hemoglobin
FROM "labevents" 
right join target_cohort using (hadm_id)
where itemid = any(array[50811,51222])
and valuenum is not null and hadm_id is not null
group by (hadm_id,time)
order by hadm_id
)

, hemoglobin_rate as
(
SELECT hadm_id, charttime as time, avg(valuenum) as hemoglobin_rate
FROM "labevents" 
right join target_cohort using (hadm_id)
where itemid = 50810
and valuenum is not null and hadm_id is not null
group by (hadm_id,time)
order by hadm_id
)

, Glucose as
(
SELECT hadm_id, charttime as time, avg(valuenum) as Glucose
FROM "labevents" 
right join target_cohort using (hadm_id)
where itemid in (50931)
and valuenum is not null and hadm_id is not null
group by (hadm_id,time)
order by hadm_id
)

, BodyTemperature as
(
	SELECT hadm_id, charttime as time, avg(valuenum) as body_temperature
	FROM "chartevents" 
	right join target_cohort using (hadm_id)
	where itemid in (223762,226329)
	and valuenum is not null and hadm_id is not null
	group by (hadm_id,time)
	order by hadm_id
)

, FiO2 as
(
	SELECT hadm_id, charttime as time, avg(valuenum) as fio2
	FROM "chartevents" 
	right join target_cohort using (hadm_id)
	where itemid in (223835)
	and valuenum is not null and hadm_id is not null
	group by (hadm_id,time)
	order by hadm_id
)

/*
, SvO2 as
(
	SELECT hadm_id, charttime as time, avg(valuenum) as svo2
	FROM "chartevents" 
	right join target_cohort using (hadm_id)
	where itemid in (225674,227686)
	and valuenum is not null and hadm_id is not null
	group by (hadm_id,time)
	order by hadm_id
)



*/

, SaO2 as
(
	SELECT hadm_id, charttime as time, avg(valuenum) as sao2
	FROM "chartevents" 
	right join target_cohort using (hadm_id)
	where itemid in (220227)
	and valuenum is not null and hadm_id is not null
	group by (hadm_id,time)
	order by hadm_id
)

, Cholesterol as
(
SELECT hadm_id, charttime as time, avg(valuenum) as Cholesterol
FROM "labevents" 
right join target_cohort using (hadm_id)
where itemid = 50907
and valuenum is not null and hadm_id is not null
group by (hadm_id,time)
order by hadm_id
)

, ALT as
(
SELECT hadm_id, charttime as time, avg(valuenum) as ALT
FROM "labevents" 
right join target_cohort using (hadm_id)
where itemid = 50861
and valuenum is not null and hadm_id is not null
group by (hadm_id,time)
order by hadm_id
)

, AST as
(
SELECT hadm_id, charttime as time, avg(valuenum) as AST
FROM "labevents" 
right join target_cohort using (hadm_id)
where itemid = 50878
and valuenum is not null and hadm_id is not null
group by (hadm_id,time)
order by hadm_id
)

, TG as
(
SELECT hadm_id, charttime as time, avg(valuenum) as TG
FROM "labevents" 
right join target_cohort using (hadm_id)
where itemid = 51000
and valuenum is not null and hadm_id is not null
group by (hadm_id,time)
order by hadm_id
)

, TC as
(
SELECT hadm_id, charttime as time, avg(valuenum) as TC
FROM "labevents" 
right join target_cohort using (hadm_id)
where itemid = 50907
and valuenum is not null and hadm_id is not null
group by (hadm_id,time)
order by hadm_id
)

, LDL as
(
SELECT hadm_id, charttime as time, avg(valuenum) as LDL
FROM "labevents" 
right join target_cohort using (hadm_id)
where itemid in (50905,50906)
and valuenum is not null and hadm_id is not null
group by (hadm_id,time)
order by hadm_id
)

, HDL as
(
SELECT hadm_id, charttime as time, avg(valuenum) as HDL
FROM "labevents" 
right join target_cohort using (hadm_id)
where itemid = 50904
and valuenum is not null and hadm_id is not null
group by (hadm_id,time)
order by hadm_id
)

, CK as
(
SELECT hadm_id, charttime as time, avg(valuenum) as CK
FROM "labevents" 
right join target_cohort using (hadm_id)
where itemid = 50910
and valuenum is not null and hadm_id is not null
group by (hadm_id,time)
order by hadm_id
)

, TNI as
(
SELECT hadm_id, charttime as time, avg(valuenum) as TNI
FROM "labevents" 
right join target_cohort using (hadm_id)
where itemid = 51002
and valuenum is not null and hadm_id is not null
group by (hadm_id,time)
order by hadm_id
)

, TNT as
(
SELECT hadm_id, charttime as time, avg(valuenum) as TNT
FROM "labevents" 
right join target_cohort using (hadm_id)
where itemid = 51003
and valuenum is not null and hadm_id is not null
group by (hadm_id,time)
order by hadm_id
)

, drug as(
SELECT subject_id, hadm_id, starttime as startdate, stoptime as enddate
	, (case
			when drug like '%Captopril%'
				then 'Captopril'
			when drug like '%Metoprolol%'
				then 'Metoprolol'
			when drug like '%Bumetanide%'
				then 'Bumetanide'
			when drug like '%Atorvastatin%'
				then 'Atorvastatin'
			when drug like '%Simvastatin%'
				then 'Simvastatin'
			when drug like '%Aspirin%'
				then 'Aspirin'
			when drug like '%Clopidogrel%'
				then 'Clopidogrel'
			else NULL end )as drug
	, dose_val_rx as val
FROM "prescriptions" left join target_cohort using(subject_id, hadm_id)
where drug like any(array['%Captopril%', '%Metoprolol%', '%Bumetanide%', '%Atorvastatin%', '%Simvastatin%', '%Aspirin%', '%Clopidogrel%'])
			and hadm_id is not null
			and starttime is not null
			and stoptime is not null
order by subject_id, hadm_id, startdate, enddate
)

, main_ as(
select hadm_id, (extract('Day' from (time-icustart))*24+extract('Hour' from (time-icustart))+extract('Minute' from (time-icustart))/60 + extract('second' from (time-icustart))/3600) as hour_, time, (time-icustart) as time_
	, Arterial_BP_Systolic
	, Arterial_BP_Mean
	, Heart_Rate
	, Respiratory_Rate
	, SpO2
	, hemoglobin
	, hemoglobin_rate
	, Glucose
	, body_temperature
	, fio2
	, sao2
	
	, Cholesterol
	, ALT
	, AST
	, TG
	, TC
	, LDL
	, HDL
	, CK
	, TNI
	, TNT

	, final_expire_flag
from BP_S
full outer join BP_M using (hadm_id, time)
full outer join Heart_Rate using (hadm_id, time)
full outer join Respiratory_Rate using (hadm_id, time)
full outer join SpO2 using (hadm_id, time)
full outer join hemoglobin using (hadm_id, time)
full outer join hemoglobin_rate using (hadm_id, time)
full outer join Glucose using (hadm_id, time)
full outer join BodyTemperature using (hadm_id,time)
full outer join FiO2 using (hadm_id,time)
full outer join SaO2 using (hadm_id,time)

full outer join Cholesterol using (hadm_id, time)
full outer join ALT using (hadm_id, time)
full outer join AST using (hadm_id, time)
full outer join TG using (hadm_id, time)
full outer join TC using (hadm_id, time)
full outer join LDL using (hadm_id, time)
full outer join HDL using (hadm_id, time)
full outer join CK using (hadm_id, time)
full outer join TNI using (hadm_id, time)
full outer join TNT using (hadm_id, time)

left outer join target_cohort using(hadm_id)
left outer join death using (hadm_id)
left join icustay using (hadm_id)
where time is not null and final_expire_flag is not null and time between icustart and icuend
order by hadm_id, time
)

, inputs_ as(
	select hadm_id, itemid, starttime as ipstart, endtime as ipend, (extract('Day' from (endtime-starttime))*24+extract('Hour' from (endtime-starttime))+extract('MINUTE' from (endtime-starttime))*1.0/60+extract('second' from (endtime-starttime))*1.0/3600) as timegap
			, (case 
					when starttime < icustart
						then icustart
					when starttime >= icustart
						then starttime
					else null end) as starttime
			, (case 
					when endtime > icuend 
						then icuend
					when endtime <= icuend
						then endtime
					else NULL end)as endtime
			, (case
					when amountuom = 'mcg'
						then (amount/1000)
					when amountuom = 'mg'
						then amount
					else null end) as amount
	from inputevents
	right join target_cohort using (hadm_id)
	left join icustay using (hadm_id)
	where ((starttime between icustay.icustart and icustay.icuend or endtime between icustay.icustart and icustay.icuend)
					or (starttime < icustay .icustart and endtime > icustay.icuend))
		and itemid = any(array[221429,221468,222056,222318,225974,225153])
		and amount is not null and amount > 0
		and (amountuom ='mcg' or amountuom = 'mg')
	order by hadm_id, itemid
)

, inputs as(
	select hadm_id, itemid, starttime, endtime, avg((amount*1.0/timegap)) as rate
	from inputs_
	group by (hadm_id, itemid, starttime, endtime)
	order by hadm_id, itemid, starttime, endtime
)

, Nitroglycerin_0 as(
  select hadm_id, starttime, endtime, time, rate
	, (case
			when date_trunc('h', time) >= starttime
				then date_trunc('h', time)
			else starttime end)as hourstart
	, (case
			when (date_trunc('h', time)+interval '1' HOUR) <= endtime
				then date_trunc('h', time)+interval '1' HOUR
			else endtime end)as hourend	
	from inputs
	right join main_ using (hadm_id)
	where itemid=222056
		and (time >= inputs.starttime and time < inputs.endtime)
	order by hadm_id,time, starttime, endtime
)

, Nitroglycerin_1 as(
  select hadm_id, date_trunc('h', hourstart) as hourlabel, hourstart, hourend, (extract('Day' from (hourend-hourstart))*24+extract('Hour' from (hourend-hourstart))+extract('Minute' from (hourend-hourstart))*1.0/60+extract('Second' from (hourend-hourstart))*1.0/3600) as duration, avg(rate) as rate
	from Nitroglycerin_0
	group by (hadm_id, hourstart, hourend)
	order by hadm_id, hourlabel, hourstart, hourend
)

, Nitroglycerin_2 as(
  select hadm_id, hourlabel, sum(duration*rate) as houramount
	from Nitroglycerin_1
	group by (hadm_id, hourlabel)
	order by hadm_id, hourlabel
)

, Nitroglycerin as(
  select hadm_id, time
	, max(case
			when time between hourlabel and (hourlabel + interval '59' MINUTE + interval '59' SECOND )
				then houramount
			else 0 end)	as Nitroglycerin
	from main_
	left join Nitroglycerin_2 using (hadm_id)
	-- where time between hourlabel and (hourlabel + interval '59' MINUTE + interval '59' SECOND )
	group by (hadm_id,time)
	order by hadm_id, time
)

, Esmolol_0 as(
  select hadm_id, starttime, endtime, time, rate
	, (case
			when date_trunc('h', time) >= starttime
				then date_trunc('h', time)
			else starttime end)as hourstart
	, (case
			when (date_trunc('h', time)+interval '1' HOUR) <= endtime
				then date_trunc('h', time)+interval '1' HOUR
			else endtime end)as hourend	
	from inputs
	right join main_ using (hadm_id)
	where itemid=221429
		and (time >= inputs.starttime and time < inputs.endtime)
	order by hadm_id,time, starttime, endtime
)

, Esmolol_1 as(
  select hadm_id, date_trunc('h', hourstart) as hourlabel, hourstart, hourend, (extract('Day' from (hourend-hourstart))*24+extract('Hour' from (hourend-hourstart))+extract('Minute' from (hourend-hourstart))*1.0/60+extract('Second' from (hourend-hourstart))*1.0/3600) as duration, avg(rate) as rate
	from Esmolol_0
	group by (hadm_id, hourstart, hourend)
	order by hadm_id, hourlabel, hourstart, hourend
)

, Esmolol_2 as(
  select hadm_id, hourlabel, sum(duration*rate) as houramount
	from Esmolol_1
	group by (hadm_id, hourlabel)
	order by hadm_id, hourlabel
)

, Esmolol as(
  select hadm_id, time
	, max(case
			when time between hourlabel and (hourlabel + interval '59' MINUTE + interval '59' SECOND )
				then houramount
			else 0 end)	as Esmolol
	from Esmolol_2
	right join main_ using (hadm_id)
	-- where time between hourlabel and (hourlabel + interval '59' MINUTE + interval '59' SECOND )
	group by (hadm_id,time)
	order by hadm_id, time
)

, Diltiazem_0 as(
  select hadm_id, starttime, endtime, time, rate
	, (case
			when date_trunc('h', time) >= starttime
				then date_trunc('h', time)
			else starttime end)as hourstart
	, (case
			when (date_trunc('h', time)+interval '1' HOUR) <= endtime
				then date_trunc('h', time)+interval '1' HOUR
			else endtime end)as hourend	
	from inputs
	right join main_ using (hadm_id)
	where itemid=221468
		and (time >= inputs.starttime and time < inputs.endtime)
	order by hadm_id,time, starttime, endtime
)

, Diltiazem_1 as(
  select hadm_id, date_trunc('h', hourstart) as hourlabel, hourstart, hourend, (extract('Day' from (hourend-hourstart))*24+extract('Hour' from (hourend-hourstart))+extract('Minute' from (hourend-hourstart))*1.0/60+extract('Second' from (hourend-hourstart))*1.0/3600) as duration, avg(rate) as rate
	from Diltiazem_0
	group by (hadm_id, hourstart, hourend)
	order by hadm_id, hourlabel, hourstart, hourend
)

, Diltiazem_2 as(
  select hadm_id, hourlabel, sum(duration*rate) as houramount
	from Diltiazem_1
	group by (hadm_id, hourlabel)
	order by hadm_id, hourlabel
)

, Diltiazem as(
  select hadm_id, time
	, max(case
			when time between hourlabel and (hourlabel + interval '59' MINUTE + interval '59' SECOND )
				then houramount
			else 0 end)	as Diltiazem
	from Diltiazem_2
	right join main_ using (hadm_id)
	-- where time between hourlabel and (hourlabel + interval '59' MINUTE + interval '59' SECOND )
	group by (hadm_id,time)
	order by hadm_id, time
)

, Verapamil_0 as(
  select hadm_id, starttime, endtime, time, rate
	, (case
			when date_trunc('h', time) >= starttime
				then date_trunc('h', time)
			else starttime end)as hourstart
	, (case
			when (date_trunc('h', time)+interval '1' HOUR) <= endtime
				then date_trunc('h', time)+interval '1' HOUR
			else endtime end)as hourend	
	from inputs
	right join main_ using (hadm_id)
	where itemid=222318
		and (time >= inputs.starttime and time < inputs.endtime)
	order by hadm_id,time, starttime, endtime
)

, Verapamil_1 as(
  select hadm_id, date_trunc('h', hourstart) as hourlabel, hourstart, hourend, (extract('Day' from (hourend-hourstart))*24+extract('Hour' from (hourend-hourstart))+extract('Minute' from (hourend-hourstart))*1.0/60+extract('Second' from (hourend-hourstart))*1.0/3600) as duration, avg(rate) as rate
	from Verapamil_0
	group by (hadm_id, hourstart, hourend)
	order by hadm_id, hourlabel, hourstart, hourend
)

, Verapamil_2 as(
  select hadm_id, hourlabel, sum(duration*rate) as houramount
	from Verapamil_1
	group by (hadm_id, hourlabel)
	order by hadm_id, hourlabel
)

, Verapamil as(
  select hadm_id, time
	, max(case
			when time between hourlabel and (hourlabel + interval '59' MINUTE + interval '59' SECOND )
				then houramount
			else 0 end)	as Verapamil
	from Verapamil_2
	right join main_ using (hadm_id)
	-- where time between hourlabel and (hourlabel + interval '59' MINUTE + interval '59' SECOND )
	group by (hadm_id,time)
	order by hadm_id, time
)

, Metoprolol_i_0 as(
  select hadm_id, starttime, endtime, time, rate
	, (case
			when date_trunc('h', time) >= starttime
				then date_trunc('h', time)
			else starttime end)as hourstart
	, (case
			when (date_trunc('h', time)+interval '1' HOUR) <= endtime
				then date_trunc('h', time)+interval '1' HOUR
			else endtime end)as hourend	
	from inputs
	right join main_ using (hadm_id)
	where itemid=225974
		and (time >= inputs.starttime and time < inputs.endtime)
	order by hadm_id,time, starttime, endtime
)

, Metoprolol_i_1 as(
  select hadm_id, date_trunc('h', hourstart) as hourlabel, hourstart, hourend, (extract('Day' from (hourend-hourstart))*24+extract('Hour' from (hourend-hourstart))+extract('Minute' from (hourend-hourstart))*1.0/60+extract('Second' from (hourend-hourstart))*1.0/3600) as duration, avg(rate) as rate
	from Metoprolol_i_0
	group by (hadm_id, hourstart, hourend)
	order by hadm_id, hourlabel, hourstart, hourend
)

, Metoprolol_i_2 as(
  select hadm_id, hourlabel, sum(duration*rate) as houramount
	from Metoprolol_i_1
	group by (hadm_id, hourlabel)
	order by hadm_id, hourlabel
)

, Metoprolol_i as(
  select hadm_id, time
	, max(case
			when time between hourlabel and (hourlabel + interval '59' MINUTE + interval '59' SECOND )
				then houramount
			else 0 end)	as Metoprolol_i
	from Metoprolol_i_2
	right join main_ using (hadm_id)
	-- where time between hourlabel and (hourlabel + interval '59' MINUTE + interval '59' SECOND )
	group by (hadm_id,time)
	order by hadm_id, time
)

, Labetalol_0 as(
  select hadm_id, starttime, endtime, time, rate
	, (case
			when date_trunc('h', time) >= starttime
				then date_trunc('h', time)
			else starttime end)as hourstart
	, (case
			when (date_trunc('h', time)+interval '1' HOUR) <= endtime
				then date_trunc('h', time)+interval '1' HOUR
			else endtime end)as hourend	
	from inputs
	right join main_ using (hadm_id)
	where itemid=225153
		and (time >= inputs.starttime and time < inputs.endtime)
	order by hadm_id,time, starttime, endtime
)

, Labetalol_1 as(
  select hadm_id, date_trunc('h', hourstart) as hourlabel, hourstart, hourend, (extract('Day' from (hourend-hourstart))*24+extract('Hour' from (hourend-hourstart))+extract('Minute' from (hourend-hourstart))*1.0/60+extract('Second' from (hourend-hourstart))*1.0/3600) as duration, avg(rate) as rate
	from Labetalol_0
	group by (hadm_id, hourstart, hourend)
	order by hadm_id, hourlabel, hourstart, hourend
)

, Labetalol_2 as(
  select hadm_id, hourlabel, sum(duration*rate) as houramount
	from Labetalol_1
	group by (hadm_id, hourlabel)
	order by hadm_id, hourlabel
)

, Labetalol as(
  select hadm_id, time
	, max(case
			when time between hourlabel and (hourlabel + interval '59' MINUTE + interval '59' SECOND )
				then houramount
			else 0 end)	as Labetalol
	from Labetalol_2
	right join main_ using (hadm_id)
	-- where time between hourlabel and (hourlabel + interval '59' MINUTE + interval '59' SECOND )
	group by (hadm_id,time)
	order by hadm_id, time
)

, Captopril_0 as
(
	select hadm_id, startdate, enddate, val
	from drug
	where drug like '%Captopril%'
	order by hadm_id, startdate, enddate
)
, Captopril_1 as
(
	select hadm_id, time, startdate, enddate,
		(case
			when m.time BETWEEN startdate and enddate
				then 1
			else 0 end) as Captopril
	from main_ as m
	left join Captopril_0 as c using (hadm_id)
	-- where drug like '%Captopril%'
	order by hadm_id, time
)
, Captopril as
(
	select hadm_id, time, max(Captopril) as Captopril
	from Captopril_1
	group by (hadm_id, time)
	order by hadm_id, time
)

, Metoprolol_0 as
(
	select hadm_id, startdate, enddate, val
	from drug
	where drug like '%Metoprolol%'
	order by hadm_id, startdate, enddate
)
, Metoprolol_1 as
(
	select hadm_id, time, startdate, enddate,
		(case
			when m.time BETWEEN startdate and enddate
				then 1
			else 0 end) as Metoprolol
	from main_ as m
	left join Metoprolol_0 as mtpl using (hadm_id)
	-- where drug like '%Metoprolol%'
	order by hadm_id, time
)
, Metoprolol as
(
	select hadm_id, time, max(Metoprolol) as Metoprolol
	from Metoprolol_1
	group by (hadm_id, time)
	order by hadm_id, time
)

, Atorvastatin_0 as
(
	select hadm_id, startdate, enddate, val
	from drug
	where drug like '%Atorvastatin%'
	order by hadm_id, startdate, enddate
)
, Atorvastatin_1 as
(
	select hadm_id, time, startdate, enddate,
		(case
			when m.time BETWEEN startdate and enddate
				then 1
			else 0 end) as Atorvastatin
	from main_ as m
	left join Atorvastatin_0 as a using (hadm_id)
	-- where drug like '%Metoprolol%'
	order by hadm_id, time
)
, Atorvastatin as
(
	select hadm_id, time, max(Atorvastatin) as Atorvastatin
	from Atorvastatin_1
	group by (hadm_id, time)
	order by hadm_id, time
)

, Simvastatin_0 as
(
	select hadm_id, startdate, enddate, val
	from drug
	where drug like '%Simvastatin%'
	order by hadm_id, startdate, enddate
)
, Simvastatin_1 as
(
	select hadm_id, time, startdate, enddate,
		(case
			when m.time BETWEEN startdate and enddate
				then 1
			else 0 end) as Simvastatin
	from main_ as m
	left join Simvastatin_0 as a using (hadm_id)
	-- where drug like '%Metoprolol%'
	order by hadm_id, time
)
, Simvastatin as
(
	select hadm_id, time, max(Simvastatin) as Simvastatin
	from Simvastatin_1
	group by (hadm_id, time)
	order by hadm_id, time
)

, Aspirin_0 as
(
	select hadm_id, startdate, enddate, val
	from drug
	where drug like '%Aspirin%'
	order by hadm_id, startdate, enddate
)
, Aspirin_1 as
(
	select hadm_id, time, startdate, enddate,
		(case
			when m.time BETWEEN startdate and enddate
				then 1
			else 0 end) as Aspirin
	from main_ as m
	left join Aspirin_0 as a using (hadm_id)
	-- where drug like '%Metoprolol%'
	order by hadm_id, time
)
, Aspirin as
(
	select hadm_id, time, max(Aspirin) as Aspirin
	from Aspirin_1
	group by (hadm_id, time)
	order by hadm_id, time
)

, Clopidogrel_0 as
(
	select hadm_id, startdate, enddate, val
	from drug
	where drug like '%Clopidogrel%'
	order by hadm_id, startdate, enddate
)
, Clopidogrel_1 as
(
	select hadm_id, time, startdate, enddate,
		(case
			when m.time BETWEEN startdate and enddate
				then 1
			else 0 end) as Clopidogrel
	from main_ as m
	left join Clopidogrel_0 as a using (hadm_id)
	-- where drug like '%Metoprolol%'
	order by hadm_id, time
)
, Clopidogrel as
(
	select hadm_id, time, max(Clopidogrel) as Clopidogrel
	from Clopidogrel_1
	group by (hadm_id, time)
	order by hadm_id, time
)

, Bumetanide_0 as
(
	select hadm_id, startdate, enddate, val
	from drug
	where drug like '%Bumetanide%'
	order by hadm_id, startdate, enddate
)
, Bumetanide_1 as
(
	select hadm_id, time, startdate, enddate,
		(case
			when m.time BETWEEN startdate and enddate
				then 1
			else 0 end) as Bumetanide
	from main_ as m
	left join Bumetanide_0 as a using (hadm_id)
	-- where drug like '%Metoprolol%'
	order by hadm_id, time
)
, Bumetanide as
(
	select hadm_id, time, max(Bumetanide) as Bumetanide
	from Bumetanide_1
	group by (hadm_id, time)
	order by hadm_id, time
)

, main_0 as
(
		select *
		from main_
		full outer join Nitroglycerin using (hadm_id,time)
		full outer join Diltiazem using (hadm_id,time)
		full outer join Esmolol using (hadm_id,time)
		full outer join Labetalol using (hadm_id,time)
		-- full outer join Sandostatin using (hadm_id,time)
		full outer join Verapamil using (hadm_id,time)
		full outer join Metoprolol_i using (hadm_id,time)
		
		left join Captopril using (hadm_id, time)
		left join Metoprolol using (hadm_id, time)
		left join Atorvastatin using (hadm_id, time)
		left join Simvastatin using (hadm_id, time)
		left join Aspirin using (hadm_id, time)
		left join Clopidogrel using (hadm_id, time)
		left join Bumetanide using (hadm_id, time)
		
		order by hadm_id, time
)

, main_1 as(
	select hadm_id, max(hour_) as hour_, trunc(hour_) as hourint 
	from main_0
	group by (hadm_id,hourint)
	order by hadm_id,hourint
)

, main as(
	select hadm_id,	hourint
	, arterial_bp_systolic,	arterial_bp_mean,	heart_rate,	respiratory_rate,	spo2,	hemoglobin,	hemoglobin_rate,	glucose,	body_temperature, fio2, sao2
	
	,	cholesterol,	alt,	ast, TG, TC, LDL, HDL, CK, TNI, TNT
	
	,	nitroglycerin,	diltiazem,	esmolol,	labetalol, verapamil,	metoprolol_i
	,	captopril,	metoprolol,	atorvastatin,	simvastatin,	aspirin,	clopidogrel, bumetanide, final_expire_flag
	from main_1
	left join main_0 using (hadm_id,hour_)
	order by hadm_id, hourint
)


/*select hadm_id, hourint, count(*) 
from main
group by (hadm_id, hourint)
order by count desc;*/

-- select hadm_id, time, count(*) from Nitroglycerin where hadm_id = 20004357 group by (hadm_id, time) order by count desc

/*
select hadm_id, hourint, count(*)
from main
group by hadm_id,hourint
order by count desc;
*/

select * from main;


